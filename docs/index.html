<html>

<head>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/faunadb@latest/dist/faunadb-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.25.0/ramda.min.js"></script>
  <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-sm">
        <h1>Fauna Latency Check</h1>
      </div>
    </div>

    <div class="row">
      <div class="col-sm">
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1">FaunaDB Secret</span>
          </div>
          <input id="fauna-secret" type="text" class="form-control" placeholder="FAUNA_SECRET" aria-label="FAUNA_SECRET"
            aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1">Collection Name</span>
          </div>
          <input id="collection-name" type="text" class="form-control" placeholder="Collection Name" value="session"
            aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1">Ref</span>
          </div>
          <input id="ref-id" type="text" class="form-control" placeholder="Collection Name" value="346131344"
            aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1">Time between requests (ms)</span>
          </div>
          <input id="pausetime" type="text" class="form-control" placeholder="Time between requests (default 500)"
            value="1000" aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1">Number of Loops</span>
          </div>
          <input id="num-of-loops" type="text" class="form-control" placeholder="Number of Loops(default 10)"
            value="100" aria-describedby="basic-addon1">
        </div>
        <button id="run-test" type="button" class="btn btn-primary">Run Test</button>
        <button id="stop-test" type="button" class="btn btn-danger">Stop Test</button>
      </div>
    </div>
    <div class="row">
      <div class="col-sm">
        <div id="alert-area"></div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm">
        <h2>Results</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-sm">
        <table class="table">
          <thead class="thead-dark">
            <tr>
              <th scope="col"></th>
              <th scope="col">Client Query Time (ms)</th>
              <th scope="col">Server Query Time (ms)</th>
            </tr>
          </thead>
          <tbody id="stats-table">
          </tbody>
        </table>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-6">
        <canvas id="histogram"></canvas>
      </div>
    </div>
    <div class="row">
      <div class="col-sm">
        <table class="table">
          <thead class="thead-dark">
            <tr>
              <th scope="col">#</th>
              <th scope="col">Client Query Time (ms)</th>
              <th scope="col">Server Query Time (ms)</th>
              <th scope="col">ReadOps</th>
            </tr>
          </thead>
          <tbody id="results">
          </tbody>
        </table>
      </div>
    </div>

  </div>
  <script>
    q = faunadb.query

    window.testResults = [];
    window.rawResponses = [];

    function timeout(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Utility functions
    // Comparator for sorting
    const diff = function (a, b) { return a - b; };
    const variance = (X) => {
      const square_error = R.compose(
        R.partialRight(Math.pow, [2]),
        R.subtract(R.__, R.mean(X)),
      )
      return R.compose(R.mean, R.map(square_error))(X)
    }
    const standard_deviation = R.compose(Math.sqrt, variance);
    function sortNumber(a, b) {
      return a - b;
    }
    function quantile(array, percentile) {
      array.sort(sortNumber);
      index = percentile / 100. * (array.length - 1);
      if (Math.floor(index) == index) {
        result = array[index];
      } else {
        i = Math.floor(index)
        fraction = index - i;
        result = array[i] + (array[i + 1] - array[i]) * fraction;
      }
      return result;
    }

    const createClient = (secret) => {
      const client = new faunadb.Client({ secret })

      client._observer = (val, context) => {
        // console.log('observer val:', val);
        client._lastResponse = val;
      }
      return client;
    }

    // Charting data
    window.chartColors = {
      red: 'rgb(255, 99, 132)',
      orange: 'rgb(255, 159, 64)',
      yellow: 'rgb(255, 205, 86)',
      green: 'rgb(75, 192, 192)',
      blue: 'rgb(54, 162, 235)',
      purple: 'rgb(153, 102, 255)',
      grey: 'rgb(201, 203, 207)'
    };

    const color = Chart.helpers.color;
    const barChartData = {
      labels: ['< 100', '100-200', '200 - 300', '300 - 400', '400 - 500', '500 - 600', '> 700'],
      datasets: [{
        label: 'Client Query Time',
        backgroundColor: color(window.chartColors.red).alpha(0.5).rgbString(),
        borderColor: window.chartColors.red,
        borderWidth: 1,
        data: [0, 0, 0, 0, 0, 0, 0]
      },
      {
        label: 'Server Query Time',
        backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
        borderColor: window.chartColors.blue,
        borderWidth: 1,
        data: [0, 0, 0, 0, 0, 0, 0]
      }],
    };
    window.barChartData = barChartData;

    var queryTest = async (client, queryDetails) => {
      const { refId, collection } = queryDetails;
      queryStartTime = Date.now();

      const sessionData = await client.query(
        q.Get(q.Ref(q.Collection(collection), refId)),
      );


      const queryTime = Date.now() - queryStartTime;

      const headers = client._lastResponse.responseHeaders;

      window.rawResponses.push(R.clone(client._lastResponse));

      const resultData = { clientQueryTime: queryTime, readOps: parseInt(headers['x-read-ops'], 10), serverQueryTime: parseInt(headers['x-query-time'], 10) };
      window.testResults.push(resultData)

      const clientQueryTimeArr = window.testResults.map((e) => e.clientQueryTime);
      window.clientQueryTimeArr = clientQueryTimeArr;
      const clientQueryTimeArrSorted = R.sort(diff, clientQueryTimeArr);

      const serverQueryTimeArr = window.testResults.map((e) => e.serverQueryTime);
      window.serverQueryTimeArr = serverQueryTimeArr;
      const serverQueryTimeArrSorted = R.sort(diff, serverQueryTimeArr);


      const stats = {
        clientQueryTime: {
          mean: Math.round(R.mean(clientQueryTimeArrSorted)),
          median: Math.round(clientQueryTimeArrSorted[Math.ceil(clientQueryTimeArrSorted.length / 2)]),
          stdDev: Math.round(standard_deviation(clientQueryTimeArrSorted)),
          pct95: Math.round(quantile(clientQueryTimeArrSorted, 95)),
          pct90: Math.round(quantile(clientQueryTimeArrSorted, 90)),
          iqr: Math.round(quantile(clientQueryTimeArrSorted, 75) - quantile(clientQueryTimeArrSorted, 25)),
        },
        serverQueryTime: {
          mean: Math.round(R.mean(serverQueryTimeArrSorted)),
          median: Math.round(serverQueryTimeArrSorted[Math.ceil(serverQueryTimeArrSorted.length / 2)]),
          stdDev: Math.round(standard_deviation(serverQueryTimeArrSorted)),
          pct95: Math.round(quantile(serverQueryTimeArrSorted, 95)),
          pct90: Math.round(quantile(serverQueryTimeArrSorted, 90)),
          iqr: Math.round(quantile(serverQueryTimeArrSorted, 75) - quantile(serverQueryTimeArrSorted, 25)),
        },
      }
      const statNames = {
        mean: 'Mean',
        median: 'Median',
        stdDev: 'Std. Dev.',
        pct95: '95th Percentile (slowest)',
        pct90: '90th Percentile (slowest)',
        iqr: 'Interquartile Range',
      }
      window.stats = stats;
      $('#stats-table').empty(),
        R.keys(statNames).forEach((measure) => {
          $('#stats-table').append(`<tr><th scope="row">${statNames[measure]}</th><td>${stats.clientQueryTime[measure]} ms</td><td>${stats.serverQueryTime[measure]} ms</td></tr>`)
        });

      // Update Histogram
      barChartData.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
      barChartData.datasets[1].data = [0, 0, 0, 0, 0, 0, 0];
      clientQueryTimeArrSorted.forEach(val => {
        const i = Math.floor(val / 100);
        if (i >= barChartData.datasets[0].data.length) {
          barChartData.datasets[0].data[barChartData.datasets[0].data.length - 1] =
            barChartData.datasets[0].data[barChartData.datasets[0].data.length - 1] + 1
        } else {
          barChartData.datasets[0].data[i] = barChartData.datasets[0].data[i] + 1;
        }
      });
      serverQueryTimeArrSorted.forEach(val => {
        const i = Math.floor(val / 100);
        if (i >= barChartData.datasets[1].data.length) {
          barChartData.datasets[1].data[barChartData.datasets[1].data.length - 1] =
            barChartData.datasets[1].data[barChartData.datasets[1].data.length - 1] + 1
        } else {
          barChartData.datasets[1].data[i] = barChartData.datasets[1].data[i] + 1;
        }
      });
      // Convert to percentages
      barChartData.datasets[0].data = barChartData.datasets[0].data.map(val => (Math.round((val * 100.0) / clientQueryTimeArrSorted.length)));
      barChartData.datasets[1].data = barChartData.datasets[1].data.map(val => (Math.round((val * 100.0) / serverQueryTimeArrSorted.length)));
      window.myBar.update();

      console.log({ clientQueryTime: `${queryTime} ms`, readOps: headers['x-read-ops'], serverQueryTime: `${headers['x-query-time']} ms` })
      window.fauna = client
      const nextNum = $('#results').children().length + 1;
      $('#results').prepend(`<tr><th scope="row">${nextNum}</th><td>${queryTime}</td><td>${headers['x-query-time']}</td><td>${headers['x-read-ops']}</td></tr>`)
    };

    let abortTest = false;
    const runLoop = async (client, queryDetails) => {

      const numOfLoops = R.max(parseInt($('#num-of-loops').val() || '10', 10), 0);
      const pausetime = parseInt($('#pausetime').val() || '500', 10);
      console.log(`Running for ${numOfLoops} loops...`);
      try {
        for (j = 0; j < numOfLoops; j++) {
          if (abortTest) break;
          await queryTest(client, queryDetails);
          await timeout(pausetime);
        }
      } catch (error) {
        $('#alert-area').append(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Error!</strong> ${error.message}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button></div>`);
        console.error(error);
      }
    }

    $('#run-test').on('click', function (event) {
      abortTest = false;
      console.log('run test');
      const secret = $('#fauna-secret').val();
      const refId = $('#ref-id').val();
      const collection = $('#collection-name').val();

      const queryDetails = { refId, collection };
      console.log('secret: ' + secret)
      const client = createClient(secret)
      // queryTest(client);
      runLoop(client, queryDetails);
    });

    $('#stop-test').on('click', function (event) {
      abortTest = true;
    });

    var ctx = document.getElementById('histogram').getContext('2d');
    window.myBar = new Chart(ctx, {
      type: 'horizontalBar',
      data: barChartData,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          // title: {
          //   display: true,
          //   text: 'Chart.js Bar Chart'
          // }
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              fontSize: 12,
              labelString: 'Query time (ms)',
            },
          }],
          xAxes: [{
            scaleLabel: {
              display: true,
              fontSize: 12,
              labelString: '% of requests',
            },
            ticks: {
              // Include a dollar sign in the ticks
              callback: function (value, index, values) {
                return value + '%';
              }
            }
          }],
        }
      }
    });

    // var chart = new Chart(ctx, {
    //   // The type of chart we want to create
    //   type: 'line',

    //   // The data for our dataset
    //   data: {
    //     labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
    //     datasets: [{
    //       label: 'My First dataset',
    //       backgroundColor: 'rgb(255, 99, 132)',
    //       borderColor: 'rgb(255, 99, 132)',
    //       data: [0, 10, 5, 2, 20, 30, 45]
    //     }]
    //   },

    //   // Configuration options go here
    //   options: {}
    // });


  </script>
</body>

</html>